<head>
	<title>User Story README Maker</title>
	<style>
		:root {
			--main-color: #41658A;
		}
		
		* {
			margin: 0;
		}
		body {
			font-family: sans-serif;
			background-color: var(--main-color);
		}

		header {
			height: 80px;
			background-color: white;
		}

		h1, h2 {
			margin-top: 10px;
		}

		input, button, textarea, select  {
			margin-top: 10px;
			border: 1px solid rgba(0,0,0,0.3);
			background-color: white;
			font-family: sans-serif;
			font-size: 16px;
			border-radius: 5px;
		}

		textarea {
			height: 120px;
			width: 90%;
			resize: none;
			padding: 10px;
		}

		#interface-behavior {
			height: 200px;
		}

		input, select {
			padding: 10px;
			font-size: 14px;
		}

		main {
			position: relative;
			margin: 50px auto;
			align-self: center;
			flex-direction: column;
			align-items: center;
			background-color: white;
			width: 40%;
			/*border-radius: 1rem;*/
			padding: 50px;
			border-radius: 5px;
			box-shadow: 0px 0px 10px rgba(0,0,0,0.3);
		}

		button {
			padding: 10px;
			border-radius: 0.3rem;
			color: white;
			border: none;
			font-size: 1rem;
			cursor: pointer;
		}

		.add-button {
			background-color: var(--main-color);
		}

		.submit-button {
			margin-top: 40px;
			background-color: #70A37F;
			font-weight: bold;
			font-size: 1.2rem;
			padding: 15px;
		}	

		.delete-button {
			background-color: #B57474;
		}

		.mb-15 {
			margin-bottom: 15px;
		}

		.mb-20 {
			margin-bottom: 20px;
		}

		.width-60 {
			width: 60%;
		}

		form {
			text-align: center;
		}
	</style>
	<script>
		function getFieldsData () {
			fetch('http://localhost:5000/getFieldsData', {
				method: 'POST',
			}).then((res) => {
				return res.json().then((data) => {
					const userStoryId = data.userStoryId
					const title = data.title
					const userStory = data.userStory
					const imageFieldsData = data.imageFieldsDataArray
					const interfaceBehavior = data.interfaceBehavior
					const comments = data.comments
					const frontendTasksData = data.frontendTasksData
					const backendTasksData = data.backendTasksData
					const titleField = document.querySelector('#title')
					const userStoryField = document.querySelector('#user-story')
					for (imageFieldData of imageFieldsData) {
						addImageInputsFields(imageFieldData)
					}
					const interfaceBehaviorField = document.querySelector('#interface-behavior')
					const commentsField = document.querySelector('#comments')
					titleField.value = `[${userStoryId}]: ${title}`
					userStoryField.value = userStory
					interfaceBehaviorField.value = interfaceBehavior
					commentsField.value = comments
					for (frontendTaskData of frontendTasksData) {
						addTaskInputsFields ('frontend', tasksData=frontendTaskData)
					}
					for (backendTaskData of backendTasksData) {
						addTaskInputsFields ('backend', tasksData=backendTaskData)
					}
				})
			}).catch((error) => {
				console.log('O arquivo README.md não existe no diretório')
			})
		}

		function getStringBetween (char1, char2, text) {
			return text.split(char1)[1].split(char2)[0]
		}

		function addImageInputsFields (imageFieldData=undefined) {
			let imageDescriptionValue = ''
			let imageSrcValue = ''
			if (imageFieldData) {
				imageDescriptionValue = `value="${getStringBetween('![', ']', imageFieldData)}"`
				imageSrcValue = `value="${getStringBetween('](', ')', imageFieldData)}"`
			}
			const imageFieldsContainer = document.querySelector('#image-fields-container')
			let imageFieldsContainerInnerHTML = imageFieldsContainer.innerHTML
			const i = document.querySelectorAll('[id*="image-alt"]').length
			imageFieldsContainerInnerHTML = imageFieldsContainerInnerHTML + `
			       <div id="image-fields-container-${i + 1}">
					<input id="image-alt-${i + 1}" type="text" ${imageDescriptionValue} placeholder="Descrição da imagem">
					<input id="interface-model-image-src-${i + 1}" type="text" ${imageSrcValue} placeholder="src da imagem">
				    <button onclick="deleteImageFieldsContainer(${i + 1})" type="button" class="delete-button">Excluir</button>
				</div>
			`
			imageFieldsContainer.innerHTML = imageFieldsContainerInnerHTML
			const imageDescriptionFields = document.querySelectorAll('[placeholder="Descrição da imagem"]')
			/*if (imageDescriptionFields.length > 1) {
				for (imageDescriptionFields of imageDescriptionFields) {
					imageDescriptionFields.addEventListener('')
				}
			}*/
		}

		function deleteImageFieldsContainer (imageFieldContainerId) {
			document.querySelector(`#image-fields-container-${imageFieldContainerId}`).remove()
		}

		function addTaskInputsFields (taskType, tasksData={}) {
			if (taskType !== 'backend' && taskType !== 'frontend') {
				console.log('addTaskInputsFields(): Escolha um tipo de tarefa válido')
				return
			}
			let taskDescriptionValue = ''
			let taskAssignmentValue = ''
			const devSelectedArray = [
				'-- Atribuição --',
				'cleogarcia',
				'diunkz',
				'gaspar51',
				'icarosun',
				'LGugs',
				'shl0mo'
			]
			const tasksFieldsContainer = document.querySelector(`#${taskType}-tasks-fields-container`)
			let tasksFieldsContainerInnerHTML = tasksFieldsContainer.innerHTML
			const i = document.querySelectorAll('[id*="task-description-"]').length
			if (JSON.stringify(tasksData) !== "{}") {
				taskDescriptionValue = `value="${tasksData.taskDescription}`
				for (let i = 0; i < devSelectedArray.length; i++) {
					if (devSelectedArray[i] === tasksData.taskAssignment)
						devSelectedArray[i] = 'selected'
					else
						devSelectedArray[i] = ''
				}
			}
			tasksFieldsContainerInnerHTML = tasksFieldsContainerInnerHTML + `
				<div id="${taskType}-task-fields-container-${i + 1}">
					<input id="${taskType}-task-description-${i + 1}" type="text" class="width-60" ${taskDescriptionValue}"" placeholder="Descrição da tarefa">
					<select id="${taskType}-task-assignment-${i + 1}" placeholder="Atribuição" required>
						<option value="" ${devSelectedArray[0]}>-- Atribuição --</option>
						<option value="cleogarcia" ${devSelectedArray[1]}>cleogarcia</option>
						<option value="diunkz" ${devSelectedArray[2]}>diunkz</option>
						<option value="gaspar51" ${devSelectedArray[3]}>gaspar51</option>
						<option value="icarosun" ${devSelectedArray[4]}>icarosun</option>
						<option value="LGugs" ${devSelectedArray[5]}>LGugs</option>
						<option value="shl0mo" ${devSelectedArray[6]}>shl0mo</option>
					</select>
					<button onclick="deleteTaskFieldsContainer(${i + 1}, '${taskType}')" type="button" class="delete-button">Excluir</button>
				</div>
			`
			tasksFieldsContainer.innerHTML = tasksFieldsContainerInnerHTML
		}

		function deleteTaskFieldsContainer (taskFieldContainerId, taskType) {
			document.querySelector(`#${taskType}-task-fields-container-${taskFieldContainerId}`).remove()
		}

		function populateTasksArray (tasksArray, tasksDescriptionsInputs, tasksAssignmentsSelects) {
			for (let i = 0; i < tasksDescriptionsInputs.length; i++) {
				const taskDescription = tasksDescriptionsInputs[i].value
				const taskAssignment = tasksAssignmentsSelects[i].value
				tasksArray.push({
					taskDescription: taskDescription,
					taskAssignment: taskAssignment
				})
			}
		}

		function makeREADME () {
			const title = document.querySelector('#title').value
			const userStory = document.querySelector('#user-story').value
			const imageFieldsDataArray = []
			const imageDescriptionInputs = document.querySelectorAll('[id*=image-alt-]')
			const imageImageSrcInputs = document.querySelectorAll('[id*=interface-model-image-src-]')
			for (let i = 0; i < imageDescriptionInputs.length; i++) {
				const imageDescription = imageDescriptionInputs[i].value
				const imageSrc = imageImageSrcInputs[i].value
				imageFieldsDataArray.push({
					imageDescription: imageDescription,
					imageSrc: imageSrc
				})
			}
			const interfaceBehavior = document.querySelector('#interface-behavior').value
			const comments = document.querySelector('#comments').value
			const frontendTasksArray = []
			const backendTasksArray = []
			const frontendTasksDescriptionInputs = document.querySelectorAll('[id*=frontend-task-description-]')
			const frontendTasksAssignmentSelects = document.querySelectorAll('[id*=frontend-task-assignment-]')
			const backendTasksDescriptionInputs = document.querySelectorAll('[id*=backend-task-description-]')
			const backendTasksAssignmentSelects = document.querySelectorAll('[id*=backend-task-assignment-]')
			populateTasksArray(frontendTasksArray, frontendTasksDescriptionInputs, frontendTasksAssignmentSelects)
			populateTasksArray(backendTasksArray, backendTasksDescriptionInputs, backendTasksAssignmentSelects)
			const body = JSON.stringify({
				title: title,
				userStory: userStory,
				imageFieldsDataArray: imageFieldsDataArray,
				interfaceBehavior: interfaceBehavior,
				comments: comments,
				frontendTasksArray: frontendTasksArray,
				backendTasksArray: backendTasksArray
			})
			fetch('http://localhost:5000/makeREADME', {
				method: 'POST',
				headers: {
        			"Content-Type": "application/json",
      			},
				body: body
			}).then((res) => {
				if (res.status == 200) {
					alert('README criado com sucesso')
				} else {
					alert('Erro ao tentar gerar o README')
				}
			})
		}
	</script>
</head>
<body onload="getFieldsData()">
<!--header></header-->
<main>
<form action="http://localhost:5000/makeREADME" method="post">
	<div>
	<div>
		<label for="title">
			<h1>Título</h1>
		</label>
		<input id="title" type="text" name="title" placeholder="ex.: [US01]: Página Inicial" class="mb-15 width-60"/>
	</div>
	<div>
		<label for="user-story">
			<h1>História de Usuário</h1>
		</label>
		<textarea id="user-story" name="userStory" placeholder="Como [...], eu gostaria de [...] de modo que [...]." class="mb-15"></textarea>
	</div>
	<div class="mb-20">
		<label>
			<h1>Modelo(s) de Interface</h1>
		</label>
		<div id="image-fields-container">
			
		</div>
		<button type="button" onclick="addImageInputsFields()" class="add-button">Adicionar imagem</button>
	</div>
	<div>
		<label for="interface-behavior">
			<h1>Comportamento da Interface</h1>
		</label>
		<textarea id="interface-behavior" type="text" name="interfaceBehavior" clas="mb-15" class="mb-15"></textarea>
	</div>
	<div>
		<label for="comments">
			<h1>Observações</h1>
		</label>
		<textarea id="comments" type="text" name="comments" class="mb-15"></textarea>
	</div>
	<div>
		<h1>Tarefas</h1>
		<div>
			<label for="frontend-tasks">
				<h2>Frontend</h2>
			</label>
			<div id="frontend-tasks-fields-container">

			</div>
			<button type="button" onclick="addTaskInputsFields('frontend')" class="add-button mb-15">Adicionar tarefa</button>
		</div>
		<div>
			<label for="backend-tasks">
				<h2>Backend</h2>
			</label>
			<div id="backend-tasks-fields-container">

			</div>
			<button type="button" onclick="addTaskInputsFields('backend')" class="add-button">Adicionar Tarefa</button>
		</div>
	</div>
	</div>
	<button type="button" class="submit-button" onclick="makeREADME()">Gerar README</button>
</form>
</main>
</body>
